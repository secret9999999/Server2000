From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Jake Potrebic <jake.m.potrebic@gmail.com>
Date: Sun, 23 May 2021 18:32:38 -0700
Subject: [PATCH] Fix cancelling ender dragon spawn

Previously, the boss bar and fog would still show up if the dragon spawn
had been cancelled.

diff --git a/src/main/java/net/minecraft/world/level/dimension/end/EndDragonFight.java b/src/main/java/net/minecraft/world/level/dimension/end/EndDragonFight.java
index f8d846345c1cc3c78f9ac14635b26f2affc77190..7ea2f23a90c74b82dc11aa18d8b369f26c037bee 100644
--- a/src/main/java/net/minecraft/world/level/dimension/end/EndDragonFight.java
+++ b/src/main/java/net/minecraft/world/level/dimension/end/EndDragonFight.java
@@ -250,7 +250,12 @@ public class EndDragonFight {
             if (spawnState == DragonRespawnAnimation.END) {
                 this.respawnStage = null;
                 this.dragonKilled = false;
-                EnderDragon enderDragon = this.createNewDragon();
+                // Paper start - handle cancelled CreatureSpawnEvent
+                EnderDragon enderDragon = this.createNewDragon(true);
+                if (enderDragon == null) {
+                    return;
+                }
+                // Paper end
 
                 for(ServerPlayer serverPlayer : this.dragonEvent.getPlayers()) {
                     CriteriaTriggers.SUMMONED_ENTITY.trigger(serverPlayer, enderDragon);
@@ -422,11 +427,25 @@ public class EndDragonFight {
     }
 
     private EnderDragon createNewDragon() {
+        // Paper start
+        return this.createNewDragon(false);
+    }
+    private @Nullable EnderDragon createNewDragon(boolean respawn) {
+        // Paper end
         this.level.getChunkAt(new BlockPos(0, 128, 0));
         EnderDragon enderDragon = EntityType.ENDER_DRAGON.create(this.level);
         enderDragon.getPhaseManager().setPhase(EnderDragonPhase.HOLDING_PATTERN);
         enderDragon.moveTo(0.0D, 128.0D, 0.0D, this.level.random.nextFloat() * 360.0F, 0.0F);
-        this.level.addFreshEntity(enderDragon);
+        // Paper start - handle cancelled CreatureSpawnEvent
+        if (!this.level.addFreshEntity(enderDragon, org.bukkit.event.entity.CreatureSpawnEvent.SpawnReason.ENDER_DRAGON_BOSS)) {
+            this.dragonKilled = true;
+            this.dragonEvent.setVisible(false);
+            if (respawn) {
+                this.spawnExitPortal(true); // revert to lit portal
+            }
+            return null;
+        }
+        // Paper end
         this.dragonUUID = enderDragon.getUUID();
         this.resetSpikeCrystals(); // Paper
         return enderDragon;
