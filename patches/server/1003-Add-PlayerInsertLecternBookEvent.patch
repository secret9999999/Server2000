From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Mariell Hoversholm <proximyst@proximyst.com>
Date: Sat, 29 Aug 2020 21:55:50 +0200
Subject: [PATCH] Add PlayerInsertLecternBookEvent


diff --git a/src/main/java/net/minecraft/world/level/block/LecternBlock.java b/src/main/java/net/minecraft/world/level/block/LecternBlock.java
index d8489fc7bbc57aa2a53026c79d2e2b2718b32912..e645aad815489a3774ab7ca40ea687fda95181d0 100644
--- a/src/main/java/net/minecraft/world/level/block/LecternBlock.java
+++ b/src/main/java/net/minecraft/world/level/block/LecternBlock.java
@@ -135,6 +135,7 @@ public class LecternBlock extends BaseEntityBlock {
         if (!(Boolean) state.getValue(LecternBlock.HAS_BOOK)) {
             if (!world.isClientSide) {
                 LecternBlock.placeBook(user, world, pos, state, stack);
+                return world.getBlockEntity(pos) instanceof final LecternBlockEntity lectern && lectern.hasBook(); // Paper - Add PlayerInsertLecternBookEvent
             }
 
             return true;
@@ -149,7 +150,11 @@ public class LecternBlock extends BaseEntityBlock {
         if (tileentity instanceof LecternBlockEntity) {
             LecternBlockEntity tileentitylectern = (LecternBlockEntity) tileentity;
 
-            tileentitylectern.setBook(stack.split(1));
+            // Paper start - Add PlayerInsertLecternBookEvent
+            if (user instanceof final net.minecraft.world.entity.player.Player player) tileentitylectern.setBook(stack.split(1), player);
+            else tileentitylectern.setBook(stack.split(1));
+            if (!tileentitylectern.hasBook()) return;
+            // Paper end - Add PlayerInsertLecternBookEvent
             LecternBlock.resetBookState(user, world, pos, state, true);
             world.playSound((Player) null, pos, SoundEvents.BOOK_PUT, SoundSource.BLOCKS, 1.0F, 1.0F);
         }
diff --git a/src/main/java/net/minecraft/world/level/block/entity/LecternBlockEntity.java b/src/main/java/net/minecraft/world/level/block/entity/LecternBlockEntity.java
index b0901efbaed533bade4b0eb130875aef3c6cd420..96b849b7e320aa11d79a13d05c6babe2b841be96 100644
--- a/src/main/java/net/minecraft/world/level/block/entity/LecternBlockEntity.java
+++ b/src/main/java/net/minecraft/world/level/block/entity/LecternBlockEntity.java
@@ -216,6 +216,17 @@ public class LecternBlockEntity extends BlockEntity implements Clearable, MenuPr
 
     public void setBook(ItemStack book, @Nullable Player player) {
         this.book = this.resolveBook(book, player);
+        // Paper start - Add PlayerInsertLecternBookEvent
+        if (level != null && player instanceof net.minecraft.server.level.ServerPlayer serverPlayer) {
+            io.papermc.paper.event.player.PlayerInsertLecternBookEvent event = new io.papermc.paper.event.player.PlayerInsertLecternBookEvent(
+                serverPlayer.getBukkitEntity(),
+                (org.bukkit.block.Lectern) org.bukkit.craftbukkit.block.CraftBlock.at(level, this.worldPosition).getState(),
+                org.bukkit.craftbukkit.inventory.CraftItemStack.asBukkitCopy(this.book)
+            );
+            if (!event.callEvent()) this.book = ItemStack.EMPTY;
+            else this.book = org.bukkit.craftbukkit.inventory.CraftItemStack.asNMSCopy(event.getBook());
+        }
+        // Paper end - Add PlayerInsertLecternBookEvent
         this.page = 0;
         this.pageCount = WrittenBookItem.getPageCount(this.book);
         this.setChanged();
